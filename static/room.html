<!DOCTYPE html>
<html>
<head>
    <title>DrawMyGame MultiPlayer Game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <style>
        html, body {
            display: flex;
            flex-direction: column;
            justify-content: start;
            align-items: center;
        }
        html {
            width: 100%;
            min-height: 100%;
        }
        body {
            padding: 1em;
            gap: 1em;
            flex: 1;
            align-self: stretch;
        }
        flexcol, flexrow {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: .5em;
        }
        flexcol {
            flex-direction: column;
        }
        flexrow {
            flex-direction: row;
        }
        .fill {
            flex: 1;
        }
        @media screen and (max-width: 800px) {
            #title {
                display: none;
            }
        }
    </style>
</head>
<body style="padding: 1em; gap: 1em; justify-content: start">
    <h1 id="title">DrawMyGame MultiPlayer Game</h1>
    <flexrow id="section_join" style="display: none">
        <input id="player_name" type="text">
        <input id="player_color" type="color">
        <button id="join">Join</button>
    </flexrow>
    <flexrow id="section_show_game" style="display: none">
        <input id="show_game" type="checkbox">Show Game
        <input id="show_joypad" type="checkbox">Show Joypad
    </flexrow>
    <flexrow id="section_game" style="display: none">
        <flexcol>
            <button id="fullscreen">Fullscreen</button>
            <button id="restart">Restart</button>
        </flexcol>
        <flexcol id="game"></flexcol>
    </flexrow>
    <flexcol id="section_joypad_link" style="display: none">
        <button id="show_joypad_link">Joypad link</button>
        <div id="joypad_qrcode"></div>
    </flexcol>
    <flexcol id="section_logs" style="display: none; width: 90%">
        <input id="logs_filter" type="text">
        <p id="logs" style="border: 1px solid grey; width: 100%; height: 500px; overflow: scroll"></p>
    </flexcol>
<script type="module">
import { HAS_TOUCH, GameMap, Game, MODE_CLIENT, MSG_KEYS, MSG_KEY_LENGTH } from '../static/game.mjs'

const isMob = ( window.innerWidth <= 800 ) && ( window.innerHeight <= 600 )
const urlQueryStr = window.location.search
const urlParams = new URLSearchParams(urlQueryStr)
const isDebugMode = urlParams.get("debug") == "1"

const locPathnames = location.pathname.split('/')
const roomId = locPathnames[locPathnames.length-1]

document.getElementById("section_join").style.display = (urlParams.get("join") != "0") ? "" : "none"

document.getElementById("join").onclick = joinGame

document.getElementById("restart").onclick = restartGame

const gameParentEl = document.getElementById("game")
const map = new GameMap()
let game = null, ws = null, joined = false

const showGameEl = document.getElementById("show_game")
showGameEl.checked = isMob ? (urlParams.get("game") == "1") : (urlParams.get("game") != "0")
const showJoypadEl = document.getElementById("show_joypad")
showJoypadEl.checked = isMob ? (urlParams.get("joypad") != "0") : (urlParams.get("joypad") == "1")
const isGameVisible = () => showGameEl.checked
const isJoypadVisible = () => joined && showJoypadEl.checked
const syncGameShow = () => {
    if(game) game.showGameScene(showGameEl.checked)
    if(game) game.showJoypadScene(showJoypadEl.checked)
    document.getElementById("section_game").style.display = (isGameVisible() || isJoypadVisible()) ? "" : "none"
    document.getElementById("section_show_game").style.display = ""
    if(!isMob) document.getElementById("section_joypad_link").style.display = ""
}
showGameEl.onchange = showJoypadEl.onchange = syncGameShow

const showJoypadLinkBut = document.getElementById("show_joypad_link")
showJoypadLinkBut.onclick = async () => {
    await importJs('../static/qrcode.min.js')
    const url = URL.parse(window.location)
    url.searchParams.set("game", "0")
    url.searchParams.set("joypad", "1")
    const el = document.getElementById("joypad_qrcode")
    el.innerHTML = ""
    var qrcode = new QRCode(el, {
        text: url.toString(),
        width: 256,
        height: 256,
        colorDark : "#000000",
        colorLight : "#ffffff",
        correctLevel : QRCode.CorrectLevel.H
    })
}

const fullscrenEl = document.getElementById("fullscreen")
fullscrenEl.onclick = () => {
    if(game) game.requestFullscreen()
}

const showLogs = isDebugMode && HAS_TOUCH
if(showLogs) document.getElementById("section_logs").style.display = ""
const logsEl = document.getElementById("logs")
const logsFilterEl = document.getElementById("logs_filter")
const addLog = (...args) => {
    args = [...args]
    const logStr = args.map(JSON.stringify).join(" ")
    const divEl = document.createElement("div")
    divEl.style.display = "none"
    divEl.textContent = logStr
    logsEl.insertBefore(divEl, logsEl.firstChild)
    syncLogsEl()
}
const syncLogsEl = () => {
    const filt = logsFilterEl.value
    for(const el of logsEl.children) el.style.display = (!filt || el.textContent.indexOf(filt) >= 0) ? "" : "none"
}
logsFilterEl.onchange = syncLogsEl

// main

async function main() {
    await getMap()
    await connectToRoom()
    startGame()
}


function connectToRoom() {
    return new Promise((ok, ko) => {
        const socketProtocol = (window.location.protocol.includes('https')) ? 'wss' : 'ws'
        //const appPort = window.location.port == 3000 ? 3001 : 8080
        ws = new WebSocket(`${socketProtocol}://${window.location.host}/client`)
        ws.addEventListener('open', () => {
            console.log('Connected to server !')
            ws.send(MSG_KEYS.IDENTIFY_CLIENT + JSON.stringify({ roomId }))
        })
        ws.addEventListener('message', evt => {
            const key = evt.data.substring(0, MSG_KEY_LENGTH)
            const data = evt.data.substring(MSG_KEY_LENGTH)
            if(key === MSG_KEYS.IDENTIFY_CLIENT) handleIdentifyClient(ws, data, ok)
            else if(key === MSG_KEYS.GAME_STATE) handleGameState(ws, data)
            else if(key === MSG_KEYS.PING) handlePing(ws, data)
        })
        ws.addEventListener('close', () => {
            console.log('Disconnected from server.')
            // newDisconnectedForm(parentEl)
        })
        ws.addEventListener('error', console.error)
    })
}

async function getMap() {
    const res = await fetch(`/room/${roomId}/map`)
    const mapBin = await res.arrayBuffer()
    await map.importFromBinary(mapBin)
}

function startGame() {
    if(game) return
    if(!isGameVisible() && !isJoypadVisible()) return
    game = new Game(gameParentEl, map, ws.id, {
        mode: MODE_CLIENT,
        sendPing: () => ws.send(MSG_KEYS.PING),
        sendInputState: inputStateStr => ws.send(MSG_KEYS.PLAYER_INPUT + inputStateStr),
        debug: isDebugMode,
        onLog: showLogs ? addLog : null
    })
    syncGameShow()
    game.play()
}

function handleIdentifyClient(ws, data, next) {
    const { id, name } = JSON.parse(data)
    ws.id = id
    ws.playerName = name
    document.getElementById("player_name").value = name
    console.log(`Identified as '${id}'.`)
    next()
}

function joinGame() {
    if(!ws || joined) return
    const playerName = document.getElementById("player_name").value
    const playerColor = document.getElementById("player_color").value
    ws.send(MSG_KEYS.JOIN_GAME + JSON.stringify({
        name: playerName,
        color: playerColor,
    }))
    joined = true
    document.getElementById("section_join").style.display = "none"
    console.log(`Joined as '${playerName}'.`)
    startGame()
    if(gqme) game.canvas.focus()
}

function handleGameState(ws, data) {
    if(game) game.receiveState(data)
}

function handlePing(ws, data) {
    if(game) game.receivePing(data)
}

function restartGame() {
    if(ws) ws.send(MSG_KEYS.GAME_INSTRUCTION + "restart")
    if(game) game.canvas.focus()
}

const importJsPrms = {}
function importJs(src) {
    return importJsPrms[src] ||= new Promise((ok, ko) => {
        const scriptEl = document.createElement("script")
        scriptEl.src = src
        document.body.appendChild(scriptEl)
        scriptEl.onload = ok
        scriptEl.onerror = ko
    })
}

main()
</script>
</body>
</html> 