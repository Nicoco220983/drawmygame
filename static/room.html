<!DOCTYPE html>
<html>
<head>
    <title>DrawMyGame MultiPlayer Game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <style>
        html, body {
            display: flex;
            flex-direction: column;
            justify-content: start;
            align-items: center;
        }
        html {
            width: 100%;
            min-height: 100%;
        }
        body {
            margin: 0;
            padding: 1em;
            gap: 1em;
            flex: 1;
            align-self: stretch;
        }
        flexcol, flexrow {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: .5em;
        }
        flexcol {
            flex-direction: column;
        }
        flexrow {
            flex-direction: row;
        }
        .fill {
            flex: 1;
        }
        @media screen and (max-width: 800px) {
            h1 {
                font-size: medium;
                margin: .5em;
            }
        }
    </style>
</head>
<body style="padding: 1em; gap: 1em; justify-content: start">
    <h1>DrawMyGame MultiPlayer Game</h1>
    <flexrow id="section_join" style="display: none">
        <input id="player_name" type="text">
        <input id="player_color" type="color">
        <button id="join">Join</button>
    </flexrow>
    <flexrow id="section_show_game" style="display: none">
        <label><input id="show_game" type="checkbox"> Show Game</label>
        <label><input id="show_joypad" type="checkbox"> Show Joypad</label>
    </flexrow>
    <flexrow id="section_game" style="display: none">
        <flexcol>
            <flexrow>
                <input id="map_id" value="0">
                <button id="load_map">Load map</button>
            </flexrow>
            <button id="fullscreen">Fullscreen</button>
            <button id="start">Start</button>
            <button id="restart">Restart</button>
            <button id="stop">Stop</button>
            <button id="show_joypad_link"></button>
            <div id="joypad_qrcode"></div>
        </flexcol>
        <flexcol id="game"></flexcol>
    </flexrow>
    <flexcol id="section_logs" style="display: none; width: 90%">
        <flexrow>Logs: <input id="logs_filter" type="text"></flexrow>
        <p id="logs" style="border: 1px solid grey; width: 100%; height: 500px; overflow: scroll"></p>
    </flexcol>
<script type="module">

import { cloneCanvas, importJs } from '../static/core/v1/utils.mjs'
import {
    pack, unpack,
    HAS_TOUCH, GameMap, Game, MODE_CLIENT,
    MSG_KEY_PING, MSG_KEY_IDENTIFY_CLIENT, MSG_KEY_JOIN_GAME, MSG_KEY_STATE, MSG_KEY_GAME_INSTRUCTION, MSG_KEY_GAME_REINIT, MSG_KEY_GAME_STOPPED,
    GAME_INSTR_START, GAME_INSTR_RESTART, GAME_INSTR_STOP, GAME_INSTR_PAUSE, GAME_INSTR_UNPAUSE, GAME_INSTR_STATE,
} from '../static/core/v1/game.mjs'
import { loadCatalog } from '../static/core/v1/catalog.mjs'

const url = new URL(window.location.href)
const isDebugMode = url.searchParams.get("debug") == "1"

const mobRegex = /android|iphone|kindle|ipad/i
const IS_MOBILE = mobRegex.test(navigator.userAgent)
if(IS_MOBILE) console.log("Mobile detected")

const showLogs = isDebugMode && IS_MOBILE
if(showLogs) {
    document.getElementById("section_logs").style.display = ""
    const logsEl = document.getElementById("logs")
    const logsFilterEl = document.getElementById("logs_filter")
    const oldLog = console.log
    console.log = (...args) => {
        oldLog(...args)
        addLogEl(...args)
    }
    const oldErr = console.error
    console.error = (...args) => {
        oldErr(...args)
        addLogEl(...args)
    }
    const addLogEl = (...args) => {
        args = [...args]
        const logStr = args.map(JSON.stringify).join(" ")
        const divEl = document.createElement("div")
        divEl.style.display = "none"
        divEl.textContent = logStr
        logsEl.insertBefore(divEl, logsEl.firstChild)
        syncLogsEl()
    }
    const syncLogsEl = () => {
        const filt = logsFilterEl.value
        for(const el of logsEl.children) el.style.display = (!filt || el.textContent.indexOf(filt) >= 0) ? "" : "none"
    }
    logsFilterEl.onchange = syncLogsEl
}

try {

    const locPathnames = location.pathname.split('/')
    const roomId = locPathnames[locPathnames.length-1]
    let clientId = sessionStorage.getItem("drawmygame.clientId")

    document.getElementById("section_join").style.display = (url.searchParams.get("join") != "0") ? "" : "none"

    document.getElementById("join").onclick = () => {
        joinGame(
            document.getElementById("player_name").value,
            document.getElementById("player_color").value,
        )
    }

    document.getElementById("start").onclick = requestStartGame
    document.getElementById("restart").onclick = requestRestartGame
    document.getElementById("stop").onclick = requestStopGame

    const gameParentEl = document.getElementById("game")
    const map = new GameMap()
    let catalog = null, game = null, ws = null, joined = false

    const showGameEl = document.getElementById("show_game")
    showGameEl.checked = IS_MOBILE ? (url.searchParams.get("game") == "1") : (url.searchParams.get("game") != "0")
    const showJoypadEl = document.getElementById("show_joypad")
    showJoypadEl.checked = IS_MOBILE ? (url.searchParams.get("joypad") != "0") : (url.searchParams.get("joypad") == "1")
    const isGameVisible = () => showGameEl.checked
    const isJoypadVisible = () => joined && showJoypadEl.checked
    const syncGameShow = () => {
        if(game) {
            game.setGameSceneVisibility(isGameVisible())
            game.setJoypadSceneVisibility(isJoypadVisible())
        }
        document.getElementById("section_game").style.display = (isGameVisible() || isJoypadVisible()) ? "" : "none"
        document.getElementById("section_show_game").style.display = ""
    }
    showGameEl.onchange = function() {
        url.searchParams.set('game', showGameEl.checked ? "1" : "0")
        window.history.pushState({}, '', url)
        syncGameShow()
    }
    showJoypadEl.onchange = function() {
        url.searchParams.set('joypad', showJoypadEl.checked ? "1" : "0")
        window.history.pushState({}, '', url)
        syncGameShow()
    }

    const showJoypadLinkBut = document.getElementById("show_joypad_link")
    const joypadQrcodeEl = document.getElementById("joypad_qrcode")
    let joypadLinkShowed = false
    const syncJoypadLink = async () => {
        if(!joypadLinkShowed) {
            showJoypadLinkBut.textContent = "Show joypad link"
            joypadQrcodeEl.style.display = "none"
        } else {
            showJoypadLinkBut.textContent = "Hide joypad link"
            const qrcodeImg = await game.initQrcodeImg()
            joypadQrcodeEl.innerHTML = ""
            joypadQrcodeEl.style.display = ""
            joypadQrcodeEl.appendChild(cloneCanvas(qrcodeImg))
            if(game) game.initQrcodeSprite()
        }
    }
    syncJoypadLink()
    showJoypadLinkBut.onclick = () => {
        joypadLinkShowed = !joypadLinkShowed
        syncJoypadLink()
    }

    document.getElementById("load_map").onclick = async () => {
        const mapId = document.getElementById("map_id").value
        if(!mapId) return
        await fetch(`/room/${roomId}/map/${mapId}`, {
            method: "POST"
        })
    }

    const fullscrenEl = document.getElementById("fullscreen")
    gameParentEl.ontouchstart = evt => {
        if(!IS_MOBILE) return 
        if(!game || game.isFullscreened()) return
        const orientation = showGameEl.checked ? "portrait" : "landscape"
        game.requestFullscreen(orientation)
        evt.stopPropagation()
    }
    fullscrenEl.onclick = () => {
        if(game) game.requestFullscreen()
    }


    // main

    async function main() {
        catalog = await loadCatalog()
        await connectToRoom()
        await getMap()
        await initGame()
        requestState()
    }

    function connectToRoom() {
        return new Promise((ok, ko) => {
            const socketProtocol = (window.location.protocol.includes('https')) ? 'wss' : 'ws'
            ws = new WebSocket(`${socketProtocol}://${window.location.host}/client`)
            ws.binaryType = "arraybuffer"
            ws.addEventListener('open', () => {
                console.log('Connected to server !')
                ws.send(toWsMsg(MSG_KEY_IDENTIFY_CLIENT, pack({
                    id: clientId, roomId,
                })))
            })
            ws.addEventListener('message', evt => {
                const data = new Uint8Array(evt.data)
                const key = data[0]
                const body = data.subarray(1)
                if(key == MSG_KEY_IDENTIFY_CLIENT) handleIdentifyClient(ws, body, ok)
                else if(key == MSG_KEY_STATE) handleState(ws, body)
                else if(key == MSG_KEY_GAME_REINIT) handleGameReinit(ws)
                else if(key === MSG_KEY_GAME_STOPPED) handleGameStopped(ws)
                else if(key == MSG_KEY_PING) handlePing(ws, body)
            })
            ws.addEventListener('close', () => {
                console.log('Disconnected from server.')
                // newDisconnectedForm(parentEl)
            })
            ws.addEventListener('error', console.error)
        })
    }

    async function getMap() {
        const res = await fetch(`/room/${roomId}/map`)
        const mapBin = await res.arrayBuffer()
        await map.importFromBinary(mapBin)
    }

    let catalogLoader = null
    async function initGame(force) {
        if(!isGameVisible() && !isJoypadVisible()) return
        catalogLoader ||= catalog.preloadAll()
        await catalogLoader
        if(!game || force) {
            stopGame()
            game = new Game(gameParentEl, catalog, map, ws.id, {
                mode: MODE_CLIENT,
                sendPing: () => ws.send(toWsMsg(MSG_KEY_PING)),
                sendStates: statesBin => ws.send(toWsMsg(MSG_KEY_STATE, statesBin)),
                sendGameInstruction: instr => ws.send(toWsMsg(MSG_KEY_GAME_INSTRUCTION, new Uint8Array([instr]))),
                debug: isDebugMode,
            })
            game.run()
            syncGameShow()
        }
    }

    function requestState() {
        ws.send(toWsMsg(MSG_KEY_GAME_INSTRUCTION, new Uint8Array([GAME_INSTR_STATE])))
    }

    function handleIdentifyClient(ws, data, next) {
        const { id, name, color, suggestedName, suggestedColor } = unpack(data)
        clientId = ws.id = id
        if(name) {
            // client already has a player name: he already joined the game
            // recover this join
            joinGame(name, color)
        } else {
            document.getElementById("player_name").value = suggestedName
            document.getElementById("player_color").value = suggestedColor
        }
        sessionStorage.setItem("drawmygame.clientId", clientId)
        console.log(`Identified as '${id}'.`)
        next()
    }

    async function joinGame(name, color) {
        if(!ws || joined) return
        joined = true
        ws.send(toWsMsg(MSG_KEY_JOIN_GAME, pack({ name, color })))
        document.getElementById("section_join").style.display = "none"
        console.log(`Joined as '${name}', with color '${color}'.`)
        await initGame()
        if(game) game.focus()
    }

    function stopGame() {
        if(!game) return
        game.stop()
        gameParentEl.innerHTML = ""
    }

    function handleState(ws, data) {
        if(game) game.receiveStatesFromLeader(data)
    }

    async function handleGameReinit(ws) {
        await getMap()
        await initGame(true)
    }

    function handleGameStopped(ws) {
        stopGame()
    }

    function handlePing(ws, data) {
        if(game) game.receivePing(data)
    }

    function requestStartGame() {
        if(ws) ws.send(toWsMsg(MSG_KEY_GAME_INSTRUCTION, new Uint8Array([GAME_INSTR_START])))
        if(game) game.focus()
    }

    function requestRestartGame() {
        if(ws) ws.send(toWsMsg(MSG_KEY_GAME_INSTRUCTION, new Uint8Array([GAME_INSTR_RESTART])))
        if(game) game.focus()
    }

    function requestStopGame() {
        if(ws) ws.send(toWsMsg(MSG_KEY_GAME_INSTRUCTION, new Uint8Array([GAME_INSTR_STOP])))
        if(game) game.focus()
    }

    await main()

} catch(err) {
    if(showLogs) console.log(err.toString(), err.stack)
    throw err
}

function toWsMsg(key, bodyBin) {
    const res = new Uint8Array(1 + (bodyBin ? bodyBin.length : 0));
    res[0] = key
    if(bodyBin) res.set(bodyBin, 1)
    return res
}

</script>
</body>
</html> 