<!DOCTYPE html>
<html>
<head>
    <title>DrawMyGame Builder</title>
    <style>
        html, body {
            display: flex;
            flex-direction: column;
            justify-content: start;
            align-items: center;
        }
        html {
            width: 100%;
            min-height: 100%;
        }
        body {
            margin: 0;
            padding: 1em;
            gap: 1em;
            flex: 1;
            align-self: stretch;
        }
        flexcol, flexrow {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: .5em;
        }
        flexcol {
            flex-direction: column;
        }
        flexrow {
            flex-direction: row;
        }
        .fill {
            flex: 1;
        }
    </style>
</head>
<body style="padding: 1em; gap: 1em; justify-content: start">
    <h1>DrawMyGame Builder</h1>
    <flexrow>
        <!-- <flexrow>Box size: <input id="map_box_size" type="number"></flexrow>
        <flexrow>Width: <input id="map_nb_cols" type="number"></flexrow>
        <flexrow>Height: <input id="map_nb_rows" type="number"></flexrow> -->
        <flexrow>Width: <input id="map_width" type="number"></flexrow>
        <flexrow>Height: <input id="map_height" type="number"></flexrow>
    </flexrow>
    <flexrow>
        <button id="mode_move">[M]ove</button>
        <button id="mode_wall">[W]all</button>
        <button id="mode_platform">[P]latform</button>
    </flexrow>
    <flexrow>
        <button id="mode_erase">[E]rase</button>
        <button id="mode_nico">[N]ico</button>
        <button id="mode_sword">Sw[o]rd</button>
        <button id="mode_bomb">Bo[m]b</button>
        <button id="mode_checkpoint">[C]heckpoint</button>
        <button id="mode_star">[S]tar</button>
    </flexrow>
    <flexrow>
        <button id="mode_blob">B[l]ob</button>
        <button id="mode_ghost">[G]host</button>
        <button id="mode_spiky">S[p]iky</button>
    </flexrow>
    <flexrow>
        <button id="game_draw">[D]RAW</button>
        <button id="game_start">[P]LAY !</button>
        <button id="game_share">SHARE</button>
        <button id="game_multi">PLAY MULTI !</button>
    </flexrow>
    <flexrow id="game_url" style="display: none">
        <flexcol>
            <button id="game_url_copy">Copy URL</button>
            <div id="game_url_copied" style="display: none">Copied !</div>
        </flexcol>
        <textarea id="game_url_val" style="width: 500px; height: 50px"></textarea>
    </flexrow>
    <flexrow>
        <button id="fullscreen">Fullscreen</button>
    </flexrow>
    <flexcol id="builder"></flexcol>
    <flexcol id="game" style="padding:1em; display: none"></flexcol>
<script type="module">
import { GameMap, Game, MODE_LOCAL } from './static/game.mjs'
import { GameBuilder } from './static/builder.mjs'

const urlQueryStr = window.location.search
const urlParams = new URLSearchParams(urlQueryStr)
const isDebugMode = urlParams.get("debug") == "1"

const builderParentEl = document.getElementById("builder")
const gameParentEl = document.getElementById("game")
let map = null, gameBuilder = null, game = null

const Keys = {}
document.getElementById("mode_move").onclick = Keys["m"] = () => setMode('move')
document.getElementById("mode_wall").onclick = Keys["ww"] = () => setMode('wall', 'wall')
document.getElementById("mode_platform").onclick = Keys["wp"] = () => setMode('wall', 'platform')
document.getElementById("mode_erase").onclick = Keys["e"] = () => setMode('erase')
document.getElementById("mode_nico").onclick = Keys["en"] = () => setMode('entity', 'nico')
document.getElementById("mode_sword").onclick = Keys["eo"] = () => setMode('entity', 'sword')
document.getElementById("mode_bomb").onclick = Keys["em"] = () => setMode('entity', 'bombIt')
document.getElementById("mode_blob").onclick = Keys["el"] = () => setMode('entity', 'blob')
document.getElementById("mode_ghost").onclick = Keys["eg"] = () => setMode('entity', 'ghost')
document.getElementById("mode_spiky").onclick = Keys["ep"] = () => setMode('entity', 'spiky')
document.getElementById("mode_checkpoint").onclick = Keys["ec"] = () => setMode('entity', 'checkpt')
document.getElementById("mode_star").onclick = Keys["es"] = () => setMode('entity', 'star')
function setMode(mode, modeKey) {
    if(!gameBuilder) return
    gameBuilder.setMode(mode, modeKey)
}

document.getElementById("game_draw").onclick = Keys["d"] = startAndShowBuilder
document.getElementById("game_start").onclick = Keys["p"] = startAndShowGame
document.getElementById("game_share").onclick = async () => {
    const mapStr = await map.exportAsSafeBase64()
    console.log(`Map export size: ${mapStr.length}`)
    const valEl = document.getElementById("game_url_val")
    valEl.value = `${window.location.origin}?map=${mapStr}`
    document.getElementById("game_url").style.display = ""
    document.getElementById("game_url_copy").onclick = () => {
        valEl.select()
        valEl.setSelectionRange(0, 99999) // For mobile devices
        navigator.clipboard.writeText(valEl.value)
        document.getElementById("game_url_copied").style.display = ""
    }
}
document.getElementById("game_multi").onclick = async () => {
    const res = await fetch("/newroom", { method: "POST" })
    const { roomId } = await res.json()
    const mapBin = await map.exportAsBinary()
    await fetch(`/room/${roomId}/map`, {
        method: "POST",
        body: new Blob([mapBin], {type: 'application/octet-stream'}),
    })
    // window.location = `${window.location.origin}/r/${roomId}`
    let url = `${window.location.origin}/r/${roomId}`
    if(isDebugMode) url += '?debug=1'
    window.open(url, '_blank').focus();
}

// const boxSizeEl = document.getElementById("map_box_size")
// const nbColsEl = document.getElementById("map_nb_cols")
// const nbRowsEl = document.getElementById("map_nb_rows")
const mapWidthEl = document.getElementById("map_width")
const mapHeightEl = document.getElementById("map_height")
function syncInputElSize() {
    // boxSizeEl.value = map.boxSize
    // nbColsEl.value = map.nbCols
    // nbRowsEl.value = map.nbRows
    mapWidthEl.value = map.width
    mapHeightEl.value = map.height
}
function updSize() {
    map.width = parseInt(mapWidthEl.value)
    map.height = parseInt(mapHeightEl.value)
    // map.boxSize = parseInt(boxSizeEl.value)
    // map.nbCols = parseInt(nbColsEl.value)
    // map.nbRows = parseInt(nbRowsEl.value)
    //map.syncSize()
    if(gameBuilder) gameBuilder.syncSize()
}
mapWidthEl.onchange = mapHeightEl.onchange = updSize

const fullscreenEl = document.getElementById("fullscreen")
fullscreenEl.onclick = () => {
    if(game) game.requestFullscreen()
}

let keyLastTime = -1, currentKey = ""
document.addEventListener('keydown', evt => {
    const time = new Date().getTime() / 1000
    if(time - keyLastTime > 1) currentKey = ""
    keyLastTime = time
    currentKey += evt.key
    const action = Keys[currentKey]
    if(action) action()
})

// main

async function main() {
    map = new GameMap()
    if(urlParams.has("map")) await map.importFromSafeBase64(urlParams.get("map"))
    //map.syncSize()
    syncInputElSize()
    if(urlParams.has("map")) {
        startAndShowGame()
    } else {
        startAndShowBuilder()
        setMode("move")
    }
}

function startAndShowBuilder() {
    gameParentEl.style.display = "none"
    stopGame()
    if(!gameBuilder) gameBuilder = new GameBuilder(builderParentEl, map)
    gameBuilder.play()
    builderParentEl.style.display = ""
}

function stopBuilder() {
    if(gameBuilder) gameBuilder.stop()
}

function startAndShowGame() {
    builderParentEl.style.display = "none"
    stopBuilder()
    if(!game) {
        const playerId = "0"
        game = new Game(gameParentEl, map, playerId, {
            mode: MODE_LOCAL,
            debug: isDebugMode
        })
        // game.showJoypadScene(true)
        game.addPlayer(playerId, {
            name: null,
            color: "blue",
        })
        game.play()
    } else {
        game.restart()
    }
    gameParentEl.style.display = ""
    game.canvas.focus()
}

function stopGame() {
    if(!game) return
    game.stop()
    gameParentEl.innerHTML = ""
    game = null
}

main()
</script>
</body>
</html> 